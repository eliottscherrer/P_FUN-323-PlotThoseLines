@page "/settings"
@inject PlotThoseLines.Services.SettingsService SettingsService
@inject HttpClient Http

<div class="settings-title">API Settings</div>
<div class="input-row">
    <div class="input-wrap">
        <span class="left-icon"><i class="bi bi-key"></i></span>
        <input class="settings-input" placeholder="Enter your TokenInsight API key" value="@apiKey" @oninput="OnApiKeyChanged" />
    </div>
    @if (saved)
    {
        <div class="saved-chip"><i class="bi bi-check"></i>Saved</div>
    }
</div>
@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="error">@error</div>
}

@code {
    private string? apiKey;
    private bool saved;
    private string? error;
    private System.Timers.Timer? debounceTimer;

    protected override void OnInitialized()
    {
        apiKey = SettingsService.GetApiKey();
        SetupDebounce();
    }

    private void SetupDebounce()
    {
        debounceTimer = new System.Timers.Timer(500);
        debounceTimer.AutoReset = false;
        debounceTimer.Elapsed += async (_, __) => await SaveAsync();
    }

    private async Task SaveAsync()
    {
        try
        {
            await SettingsService.SetApiKeyAsync(apiKey);
            Http.DefaultRequestHeaders.Remove("TI_API_KEY");
            if (!string.IsNullOrWhiteSpace(apiKey))
            {
                Http.DefaultRequestHeaders.Add("TI_API_KEY", apiKey);
            }
            saved = true;
            error = null;
            await InvokeAsync(StateHasChanged);
            await Task.Delay(1200);
            saved = false;
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private void OnApiKeyChanged(ChangeEventArgs e)
    {
        apiKey = e.Value?.ToString();
        saved = false;
        debounceTimer?.Stop();
        debounceTimer?.Start();
    }
}
