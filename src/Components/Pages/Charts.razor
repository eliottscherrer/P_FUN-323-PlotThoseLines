@using Microsoft.AspNetCore.Components.Forms;
@using PlotThoseLines.Services;
@using PlotThoseLines.Extensions;
@using System.Text.Json;
@inject LocalAssetService LocalAssetService
@inject CoinHistoryService CoinHistoryService
@inject ChartsStateService StateService
@page "/"
@implements IDisposable

<div @onclick="CloseDropdown">
<h1>Charts</h1>

<div class="form-group row mb-3">
    <div class="col-md-12 controls-container">
        <div class="assets-section">
            @if (selectedAssets != null && selectedAssets.Any())
            {
                @foreach (var asset in selectedAssets)
                {
                    <div class="asset-chip @(asset.IsLocal ? "local-asset-chip" : "")">
                        <div class="position-relative">
                            @if (!string.IsNullOrEmpty(asset.Logo))
                            {
                                <img src="@asset.Logo" alt="@asset.Symbol" class="asset-chip-logo" />
                            }
                            @if (asset.IsLocal)
                            {
                                <span class="chip-local-badge">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-laptop-minimal-icon lucide-laptop-minimal"><rect width="18" height="12" x="3" y="4" rx="2" ry="2" /><line x1="2" x2="22" y1="20" y2="20" /></svg>
                                </span>
                            }
                        </div>
                        <span class="asset-chip-text">@asset.Symbol?.ToUpper()</span>
                        <button class="asset-chip-remove" @onclick="() => RemoveAsset(asset.Id)" title="Remove asset">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18" /><path d="m6 6 12 12" /></svg>
                        </button>
                    </div>
                }
            }

            @if (GetAvailableAssets().Count > 0)
            {
                <div class="dropdown-container" @onclick:stopPropagation="true">
                    <button class="add-asset-btn" @onclick="ToggleDropdown">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14" /><path d="M12 5v14" /></svg>
                        <span>Add asset</span>
                    </button>
                    
                    @if (isDropdownOpen && savedAssets != null)
                    {
                        <div class="asset-dropdown">
                            @if (!savedAssets.Any())
                            {
                                <div class="dropdown-empty">No assets available</div>
                            }
                            else if (GetAvailableAssets().Count > 0)
                            {
                                @* API Assets Section *@
                                @if (GetAvailableApiAssets().Any())
                                {
                                    <div class="dropdown-section-header">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-globe-icon lucide-globe"><circle cx="12" cy="12" r="10" /><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20" /><path d="M2 12h20" /></svg>
                                        API Assets
                                    </div>
                                    @foreach (var asset in GetAvailableApiAssets())
                                    {
                                        <div class="dropdown-item" @onclick="() => AddAsset(asset)">
                                            @if (!string.IsNullOrEmpty(asset.Logo))
                                            {
                                                <img src="@asset.Logo" alt="@asset.Symbol" class="dropdown-item-logo" />
                                            }
                                            <span class="dropdown-item-name">@asset.Name</span>
                                            <span class="dropdown-item-symbol">@asset.Symbol?.ToUpper()</span>
                                        </div>
                                    }
                                }
                                
                                @* Local Assets Section *@
                                @if (GetAvailableLocalAssets().Any())
                                {
                                    @if (GetAvailableApiAssets().Any())
                                    {
                                        <div class="dropdown-divider"></div>
                                    }
                                    <div class="dropdown-section-header">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-laptop-minimal-icon lucide-laptop-minimal"><rect width="18" height="12" x="3" y="4" rx="2" ry="2" /><line x1="2" x2="22" y1="20" y2="20" /></svg>
                                        Local Assets
                                    </div>
                                    @foreach (var asset in GetAvailableLocalAssets())
                                    {
                                        <div class="dropdown-item local-dropdown-item" @onclick="() => AddAsset(asset)">
                                            <div class="position-relative">
                                                @if (!string.IsNullOrEmpty(asset.Logo))
                                                {
                                                    <img src="@asset.Logo" alt="@asset.Symbol" class="dropdown-item-logo" />
                                                }
                                                <span class="dropdown-local-badge">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-laptop-minimal-icon lucide-laptop-minimal"><rect width="18" height="12" x="3" y="4" rx="2" ry="2" /><line x1="2" x2="22" y1="20" y2="20" /></svg>
                                                </span>
                                            </div>
                                            <span class="dropdown-item-name">@asset.Name</span>
                                            <span class="dropdown-item-symbol">@asset.Symbol?.ToUpper()</span>
                                        </div>
                                    }
                                }
                            }
                        </div>
                    }
                </div>
            }
        </div>

        <div class="time-range-wrapper">
            <div class="segmented" role="tablist" aria-label="Time range">
                <button type="button"
                    class='@GetSegmentClass("1d")'
                    role="tab"
                    aria-selected='@IsSelected("1d")'
                    disabled="@IsIntervalDisabled("1d")"
                    @onclick='() => SelectedRange = "1d"'>1d</button>

                <button type="button"
                    class='@GetSegmentClass("7d")'
                    role="tab"
                    aria-selected='@IsSelected("7d")'
                    disabled="@IsIntervalDisabled("7d")"
                    @onclick='() => SelectedRange = "7d"'>7d</button>

                <button type="button"
                    class='@GetSegmentClass("1m")'
                    role="tab"
                    aria-selected='@IsSelected("1m")'
                    @onclick='() => SelectedRange = "1m"'>1m</button>

                <button type="button"
                    class='@GetSegmentClass("1y")'
                    role="tab"
                    aria-selected='@IsSelected("1y")'
                    @onclick='() => SelectedRange = "1y"'>1y</button>

                <button type="button"
                    class='@GetSegmentClass("all")'
                    role="tab"
                    aria-selected='@IsSelected("all")'
                    @onclick='() => SelectedRange = "all"'>All</button>
            </div>
        </div>
    </div>
</div>

@if (savedAssets == null || !savedAssets.Any())
{
    <div class="empty-state-card">
        <div class="empty-state-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-package-open-icon lucide-package-open"><path d="M12 22v-9"/><path d="M15.17 2.21a1.67 1.67 0 0 1 1.63 0L21 4.57a1.93 1.93 0 0 1 0 3.36L8.82 14.79a1.655 1.655 0 0 1-1.64 0L3 12.43a1.93 1.93 0 0 1 0-3.36z"/><path d="M20 13v3.87a2.06 2.06 0 0 1-1.11 1.83l-6 3.08a1.93 1.93 0 0 1-1.78 0l-6-3.08A2.06 2.06 0 0 1 4 16.87V13"/><path d="M21 12.43a1.93 1.93 0 0 0 0-3.36L8.83 2.2a1.64 1.64 0 0 0-1.63 0L3 4.57a1.93 1.93 0 0 0 0 3.36l12.18 6.86a1.636 1.636 0 0 0 1.63 0z"/></svg>
        </div>
        <h2 class="empty-state-title">No Assets Available</h2>
        <p class="empty-state-description">
            Start by adding some assets to track their price history over time via a chart.
        </p>
        <a href="/assets" class="empty-state-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
            Go to Assets
        </a>
    </div>
}
else if (selectedAssets != null && !selectedAssets.Any() && !isLoading)
{
    <div class="empty-state-card">
        <div class="empty-state-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-coins-icon lucide-coins"><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></svg>
        </div>
        <h2 class="empty-state-title">No Assets Selected</h2>
        <p class="empty-state-description">
            Select assets from the list above to visualize their price history over time via a chart.
        </p>
    </div>
}
else if (allAssetData.Any(d => d.Value?.market_chart != null && d.Value.market_chart.Any()))
{
    var validAssets = allAssetData.Where(d => d.Value?.market_chart != null && d.Value.market_chart.Any()).ToList();
    var isSingleAsset = validAssets.Count == 1;
    var useCandlestick = isSingleAsset && ShouldUseCandlestick();
    
    @* Min/Max Statistics Cards *@
    <div class="stats-container">
        @{
            var colorIndex = 0;
            var chartColors = new[] { "#2E93FA", "#A3E635", "#F59E0B", "#EF4444", "#8B5CF6", "#EC4899", "#14B8A6", "#F97316" };
        }
        @foreach (var assetData in validAssets)
        {
            var asset = selectedAssets?.FirstOrDefault(a => a.Id == assetData.Key);
            var chartData = GetEnhancedChartData(assetData.Value);
            var stats = CalculateStats(chartData);
            var assetColor = chartColors[colorIndex % chartColors.Length];
            colorIndex++;
            
            <div class="stat-card" style="--asset-color: @assetColor;">
                <div class="stat-card-header">
                    @if (!string.IsNullOrEmpty(asset?.Logo))
                    {
                        <img src="@asset.Logo" alt="@asset.Symbol" class="stat-card-logo" />
                    }
                    <span class="stat-card-symbol">@(asset?.Symbol?.ToUpper() ?? assetData.Key)</span>
                    @if (asset?.IsLocal == true)
                    {
                        <span class="stat-card-badge">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="12" x="3" y="4" rx="2" ry="2" /><line x1="2" x2="22" y1="20" y2="20" /></svg>
                        </span>
                    }
                </div>
                <div class="stat-card-body">
                    <div class="stat-item stat-min">
                        <div class="stat-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-down-icon lucide-trending-down"><path d="M16 17h6v-6"/><path d="m22 17-8.5-8.5-5 5L2 7"/></svg>
                            <span>Min</span>
                        </div>
                        <div class="stat-value">$@(((decimal)stats.Min).ToShortNumber())</div>
                        <div class="stat-date">@stats.MinDate.ToString("MMM dd, HH:mm")</div>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item stat-max">
                        <div class="stat-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trending-up-icon lucide-trending-up"><path d="M16 7h6v6"/><path d="m22 7-8.5 8.5-5-5L2 17"/></svg>
                            <span>Max</span>
                        </div>
                        <div class="stat-value">$@(((decimal)stats.Max).ToShortNumber())</div>
                        <div class="stat-date">@stats.MaxDate.ToString("MMM dd, HH:mm")</div>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item stat-range">
                        <div class="stat-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-brackets-icon lucide-brackets"><path d="M16 3h3a1 1 0 0 1 1 1v16a1 1 0 0 1-1 1h-3"/><path d="M8 21H5a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h3"/></svg>
                            <span>Range</span>
                        </div>
                        <div class="stat-value stat-range-value">$@(((decimal)stats.Range).ToShortNumber())</div>
                        <div class="stat-percentage @(stats.PercentageChange >= 0 ? "positive" : "negative")">
                            @(stats.PercentageChange >= 0 ? "+" : "")@stats.PercentageChange.ToString("N2")%
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    
    <ApexChart TItem="EnhancedMarketChart" Options="GetChartOptions(useCandlestick)" @ref="chartRef">
        @* Use candlestick only for single asset with interval <= 1 month, otherwise use line charts *@
        @if (useCandlestick)
        {
            var assetData = validAssets.First();
            var asset = selectedAssets?.FirstOrDefault(a => a.Id == assetData.Key);
            var seriesName = asset?.Symbol?.ToUpper() ?? assetData.Key;
            
            <ApexCandleSeries TItem="EnhancedMarketChart"
                Name="@seriesName"
                Items="GetEnhancedChartData(assetData.Value)"
                XValue="@(p => p.DateTime)"
                Open="@(p => (decimal)p.Open)"
                High="@(p => (decimal)p.High)"
                Low="@(p => (decimal)p.Low)"
                Close="@(p => (decimal)p.Close)" />
        }
        else
        {
            @foreach (var assetData in validAssets)
            {
                var asset = selectedAssets?.FirstOrDefault(a => a.Id == assetData.Key);
                var seriesName = asset?.Symbol?.ToUpper() ?? assetData.Key;
                
                <ApexPointSeries TItem="EnhancedMarketChart"
                    Name="@seriesName"
                    Items="GetEnhancedChartData(assetData.Value)"
                    SeriesType="SeriesType.Line"
                    XValue="@(p => p.DateTime)"
                    YValue="@(p => (decimal)p.Price)" />
            }
        }
    </ApexChart>
}
else if (allAssetData.Any() && allAssetData.Any(d => d.Value != null))
{
    <div class="alert alert-info">
        <strong>No chart data available.</strong> The dataset contains no valid historical data to display.
    </div>
}

@if (isLoading)
{
    <div class="d-flex justify-content-center mt-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}

@if (errorMessage != null)
{
    var alertClass = errorMessage.StartsWith("Warning:") ? "alert-warning" : "alert-danger";
    var alertTitle = errorMessage.StartsWith("Warning:") ? "Warning" : "Error";
    
    <div class="alert @alertClass mt-3">
        <strong>@alertTitle:</strong> @errorMessage
    </div>
}
</div>

    @code {
        private string interval = "day";
        private int dataLength = 30;
        private string vsCurrency = "usd";
        private Dictionary<string, CoinHistoryDataResponse?> allAssetData = new();
        private bool isLoading = false;
        private string? errorMessage;
        private List<LocalAsset>? savedAssets;
        private List<LocalAsset> selectedAssets = new();
        private string selectedAssetId = "";
        private ApexChart<EnhancedMarketChart>? chartRef;
        private bool isDropdownOpen = false;
        private string selectedRange = "1m";
        private string SelectedRange
        {
            get => selectedRange;
            set
            {
                if (selectedRange == value) return;
                selectedRange = value;
                ApplyPresetRange(value);
                SaveStateToService();
                
                if (selectedAssets.Any())
                {
                    _ = FetchData();
                }
                
                StateHasChanged();
            }
        }

        public void Dispose()
        {
            SaveStateToService();
        }

        private bool ShouldUseCandlestick()
        {
            // Only use candlestick for intervals <= 1 month
            // Don't use candlestick for 1y and All
            return selectedRange == "1d" || selectedRange == "7d" || selectedRange == "1m";
        }

        private ApexChartOptions<EnhancedMarketChart> GetChartOptions(bool useCandlestick)
        {
            return new ApexChartOptions<EnhancedMarketChart>
        {
            Chart = new Chart
            {
                Type = useCandlestick ? ChartType.Candlestick : ChartType.Line,
                Height = 600,
                Zoom = new Zoom { Enabled = true },
                Toolbar = new Toolbar { Show = true },
                ForeColor = "#334155"
            },
        Xaxis = new XAxis
        {
            Type = XAxisType.Datetime,
            Title = new AxisTitle { Text = "Date/Time" },
            Labels = new XAxisLabels
            {
                DatetimeUTC = false,
                DatetimeFormatter = new DatetimeFormatter
                {
                    Year = "yyyy",
                    Month = "dd MMM",
                    Day = "dd MMM",
                    Hour = "HH:mm"
                }
            },
            TickAmount = 6
        },
        Yaxis = new List<YAxis>
        {
            new YAxis
            {
                Title = new AxisTitle { Text = "Price (USD)" },
                Labels = new YAxisLabels
                {
                Formatter = @"  function toShortNumber(number) {
                                    if (number >= 1_000_000_000)
                                        return (number / 1_000_000_000) + 'B';
                                    
                                    if (number >= 1_000_000)
                                        return (number / 1_000_000) + 'M';
                                    
                                    if (number >= 1_000)
                                        return (number / 1_000) + 'K';
                                    
                                    return number;
                                }"
                }
            }
        },
        Stroke = new Stroke { Curve = Curve.Smooth, Width = 3 },
        DataLabels = new DataLabels { Enabled = false },
        Markers = new Markers { Size = 0 },
        Grid = new Grid
        {
            BorderColor = "#f1f1f1",
            StrokeDashArray = 4,
            Column = new GridColumn
            {
                Colors = new List<string> { "#f8f8f8", "transparent" },
                Opacity = 0.75
            }
        },
        PlotOptions = new PlotOptions
        {
            Candlestick = new PlotOptionsCandlestick
            {
                Colors = new PlotOptionsCandlestickColors
                {
                    Upward = "#d71515",
                    Downward = "#5a9f68"
                }
            }
        },
        // Random colors otherwise all the lines are blue and it's bad for clarity
        Colors = new List<string> { "#2E93FA", "#A3E635", "#F59E0B", "#EF4444", "#8B5CF6", "#EC4899", "#14B8A6", "#F97316" },
        Legend = new Legend { Show = true, Position = LegendPosition.Top },
        Tooltip = new Tooltip { Shared = true, Intersect = false, X = new TooltipX { Format = "dd MMM yyyy HH:mm" } }
        };
    }

    private List<EnhancedMarketChart> GetEnhancedChartData(CoinHistoryDataResponse? data) => CoinHistoryService.EnhanceChartData(data);

    private (double Min, double Max, double Range, double PercentageChange, DateTime MinDate, DateTime MaxDate) CalculateStats(List<EnhancedMarketChart> chartData)
    {
        if (chartData == null || !chartData.Any())
        {
            return (0, 0, 0, 0, DateTime.Now, DateTime.Now);
        }

        var prices = chartData.Select(d => d.Price).ToList();
        var min = prices.Min();
        var max = prices.Max();
        var range = max - min;
        var percentageChange = min != 0 ? ((max - min) / min) * 100 : 0;
        
        var minData = chartData.First(d => d.Price == min);
        var maxData = chartData.First(d => d.Price == max);

        return (min, max, range, percentageChange, minData.DateTime, maxData.DateTime);
    }

    protected override void OnInitialized()
    {
        LoadSavedAssets();
        
        if (StateService.IsInitialized)
        {
            RestoreStateFromService();
        }
        else
        {
            ApplyPresetRange(selectedRange);
            StateService.IsInitialized = true;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        
        if (selectedAssets.Any())
        {
            await FetchData();
        }
    }

    private void RestoreStateFromService()
    {
        interval = StateService.Interval;
        dataLength = StateService.DataLength;
        vsCurrency = StateService.VsCurrency;
        allAssetData = StateService.AllAssetData;
        selectedAssets = StateService.SelectedAssets;
        selectedRange = StateService.SelectedRange;
        errorMessage = StateService.ErrorMessage;
    }

    private void SaveStateToService()
    {
        StateService.Interval = interval;
        StateService.DataLength = dataLength;
        StateService.VsCurrency = vsCurrency;
        StateService.AllAssetData = allAssetData;
        StateService.SelectedAssets = selectedAssets;
        StateService.SelectedRange = selectedRange;
        StateService.ErrorMessage = errorMessage;
        StateService.IsInitialized = true;
    }

    // From: https://tokeninsight-api.readme.io/reference/get_history-coins-id
    // This para decides how many data points you will get in the response, and different lengths are supported for different intervals.
    // For day, any number between 1 - 365, -1 stands for the max length, and 90 is the default if left blank.
    // For hour, any number between 1 - 8784, 24 in the default if left blank.
    // For minute, any number between 1 - 10080, 60 is the default if left blank.
    private void ApplyPresetRange(string range)
    {
        switch (range)
        {
            case "1d":
                interval = "hour";
                dataLength = 24;
                break;
            case "7d":
                interval = "day";
                dataLength = 7;
                break;
            case "1m":
                interval = "day";
                dataLength = 30;
                break;
            case "1y":
                interval = "day";
                dataLength = 365;
                break;
            case "all":
                interval = "day";
                dataLength = -1;
                break;
            default:
                interval = "day";
                dataLength = 365;
                break;
        }
    }

    private bool IsSelected(string range) => SelectedRange == range;
    private string GetSegmentClass(string range) => IsSelected(range) ? "segment selected" : "segment";

    // Made to avoid selecting intervals with too few data points
    private bool IsIntervalDisabled(string range)
    {
        var localAssets = selectedAssets.Where(a => a.IsLocal).ToList();
        if (!localAssets.Any())
        {
            return false;
        }

        if (localAssets.Any(asset =>
            LocalAssetService.GetMinimumDataInterval(asset) == "day" &&
            (range == "1d" || (range == "7d" && (asset.HistoryData?.Count ?? 0) < 7))
        ))
        {
            return true;
        }

        return false;
    }

    private void LoadSavedAssets()
    {
        try
        {
            savedAssets = LocalAssetService.GetAssets();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading saved assets: {ex.Message}");
        }
    }

    private void OnAssetSelected(ChangeEventArgs e)
    {
        selectedAssetId = e.Value?.ToString() ?? "";
    }

    private void ToggleDropdown()
    {
        isDropdownOpen = !isDropdownOpen;
    }

    private List<LocalAsset> GetAvailableAssets()
    {
        if (savedAssets == null) return new List<LocalAsset>();
        
        // Return only assets that are not already selected
        return savedAssets.Where(a => !selectedAssets.Any(s => s.Id == a.Id)).ToList();
    }

    private List<LocalAsset> GetAvailableApiAssets()
    {
        return GetAvailableAssets().Where(a => !a.IsLocal).ToList();
    }

    private List<LocalAsset> GetAvailableLocalAssets()
    {
        return GetAvailableAssets().Where(a => a.IsLocal).ToList();
    }

    private void AddAsset(LocalAsset asset)
    {
        if (!selectedAssets.Any(a => a.Id == asset.Id))
        {
            selectedAssets.Add(asset);
            isDropdownOpen = false;
            SaveStateToService();
            
            _ = FetchData();
            
            StateHasChanged();
        }
    }

    private void RemoveAsset(string? assetId)
    {
        var assetToRemove = selectedAssets.FirstOrDefault(a => a.Id == assetId);
        if (assetToRemove != null)
        {
            selectedAssets.Remove(assetToRemove);
            SaveStateToService();
            
            if (!selectedAssets.Any())
            {
                errorMessage = null;
                allAssetData.Clear();
            }
            else
            {
                _ = FetchData();
            }
            
            StateHasChanged();
        }
    }

    private async Task FetchData()
    {
        // Require at least one selected asset
        if (!selectedAssets.Any())
        {
            errorMessage = "Please add at least one asset to the chart";
            return;
        }

        isLoading = true;
        errorMessage = null;
        allAssetData.Clear();
        StateHasChanged(); // Update UI to show loading state

        try
        {
            // Use the service to fetch data for all selected assets
            allAssetData = await CoinHistoryService.FetchHistoryDataAsync(
                selectedAssets,
                interval,
                dataLength,
                vsCurrency);

            // Check if any data was fetched successfully
            var validAssets = allAssetData
                .Where(d => d.Value?.market_chart != null && d.Value.market_chart.Any())
                .ToList();

            if (!validAssets.Any())
            {
                var failedAssets = selectedAssets
                    .Select(a => a.Symbol?.ToUpper() ?? a.Name ?? "Unknown")
                    .ToList();
                
                errorMessage = $"Warning: Limited or no historical data available for: {string.Join(", ", failedAssets)}. " +
                              "Displaying with placeholder values. This may be due to missing data, network issues, or the asset being newly added.";
                
                // Try to update chart anyway
                if (chartRef is not null)
                {
                    await chartRef.UpdateOptionsAsync(true, true, false, null);
                }
            }
            else
            {
                if (validAssets.Count < selectedAssets.Count)
                {
                    var failedCount = selectedAssets.Count - validAssets.Count;
                    errorMessage = $"Warning: {failedCount} asset(s) could not be loaded due to missing or invalid data. " +
                                  $"Displaying {validAssets.Count} asset(s) successfully.";
                }

                if (chartRef is not null)
                {
                    await chartRef.UpdateOptionsAsync(true, true, false, null);
                }
            }
        }
        catch (HttpRequestException httpEx)
        {
            errorMessage = $"Network error: {httpEx.Message}. Please check your internet connection and try again.";
        }
        catch (JsonException jsonEx)
        {
            errorMessage = $"Data format error: {jsonEx.Message}. The data from the source may be corrupted or in an unexpected format.";
        }
        catch (TaskCanceledException)
        {
            errorMessage = "Request timed out. The server took too long to respond. Please try again.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Unexpected error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            SaveStateToService();
            StateHasChanged(); // Ensure UI updates even if there's an error
        }
    }

    private void CloseDropdown()
    {
        if (isDropdownOpen)
        {
            isDropdownOpen = false;
            StateHasChanged();
        }
    }
}