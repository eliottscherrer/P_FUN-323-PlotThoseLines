@using Microsoft.AspNetCore.WebUtilities;
@inject HttpClient Http
@inject LocalAssetService LocalAssetService
@page "/"

<h1>Charts</h1>

<div class="form-group row mb-3">
    <div class="col-md-3">
        <label for="savedAssets">Saved Assets:</label>
        <select id="savedAssets" class="form-control" @onchange="OnAssetSelected">
            <option value="">-- Select a saved asset --</option>
            @if (savedAssets != null)
            {
                @foreach (var asset in savedAssets)
                {
                    <option value="@asset.Id">@asset.Name (@asset.Symbol?.ToUpper())</option>
                }
            }
        </select>
    </div>
    <div class="col-md-3">
        <label for="coinName">Or enter Coin ID manually:</label>
        <input id="coinName" class="form-control" @bind="coinName" placeholder="e.g., bitcoin, ethereum" />
    </div>
    <div class="col-md-2">
        <label for="interval">Interval:</label>
        <select id="interval" class="form-control" @bind="interval">
            <option value="minute">Minute</option>
            <option value="hour">Hour</option>
            <option value="day">Day</option>
        </select>
    </div>
    <div class="col-md-2">
        <label for="dataLength">Data Length:</label>
        <input id="dataLength" type="number" class="form-control" @bind="dataLength" min="1" />
    </div>
    <div class="col-md-2">
        <label for="currency">Currency:</label>
        <select id="currency" class="form-control" @bind="vsCurrency">
            <option value="usd">USD</option>
        </select>
    </div>
</div>
<div class="row mb-3">
    <div class="col-md-12 d-flex justify-content-center">
        <button class="btn btn-primary" @onclick="FetchData">
            @if (isLoading)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </span>
                <span>Loading...</span>
            }
            else
            {
                <span>Fetch Data</span>
            }
        </button>
    </div>
</div>

@if(coinHistoryData != null)
{
    <div class="card mb-4">
        <div class="card-header d-flex align-items-center">
            @if (!string.IsNullOrEmpty(coinHistoryData.logo))
            {
                <img src="@coinHistoryData.logo" alt="logo" width="40" class="me-3" />
            }
            <div>
                <h3>@coinHistoryData.name (@coinHistoryData.symbol?.ToUpper())</h3>
                <p class="mb-0">Currency: @coinHistoryData.vs_currency?.ToUpper()</p>
            </div>
        </div>
        <div class="card-body">
            <p>ID: @coinHistoryData.id</p>
            @if (coinHistoryData.page_info != null)
            {
                <p>Total Results: @coinHistoryData.page_info.total_results</p>
            }
        </div>
    </div>
}

<h3 class="mt-4">Historical Data</h3>
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Date/Time</th>
                <th>Price (@vsCurrency?.ToUpper())</th>
                <th>Market Cap</th>
                <th>24h Volume</th>
            </tr>
        </thead>
        @if (coinHistoryData?.market_chart != null)
        {
            <tbody>
                @foreach (var entry in coinHistoryData.market_chart)
                {
                    <tr>
                        <td>@DateTimeOffset.FromUnixTimeMilliseconds(entry.timestamp).ToLocalTime().ToString("g")</td>
                        <td>@entry.price.ToString("C2")</td>
                        <td>@entry.market_cap.ToString("N0")</td>
                        <td>@entry.vol_spot_24h.ToString("N0")</td>
                    </tr>
                }
            </tbody>
        }
    </table>
</div>

@if (isLoading)
{
    <div class="d-flex justify-content-center mt-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}

@if (errorMessage != null)
{
    <div class="alert alert-danger mt-3">
        <strong>Error:</strong> @errorMessage
    </div>
}

@code {
    private string coinName = "bitcoin";
    private string interval = "day";
    private int dataLength = 30;
    private string vsCurrency = "usd";
    private CoinHistoryDataResponse? coinHistoryData;
    private bool isLoading = false;
    private string? errorMessage;
    private List<LocalAsset>? savedAssets;
    private string selectedAssetId = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadSavedAssets();
    }

    private async Task LoadSavedAssets()
    {
        try
        {
            savedAssets = LocalAssetService.GetAssets();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading saved assets: {ex.Message}");
        }
    }

    private void OnAssetSelected(ChangeEventArgs e)
    {
        selectedAssetId = e.Value?.ToString() ?? "";
        if (!string.IsNullOrWhiteSpace(selectedAssetId))
        {
            coinName = selectedAssetId;
        }
    }

    private async Task FetchData()
    {
        // Use selected asset or manual input
        var targetCoinId = !string.IsNullOrWhiteSpace(selectedAssetId) ? selectedAssetId : coinName;
        
        if (string.IsNullOrWhiteSpace(targetCoinId))
        {
            errorMessage = "Please select a saved asset or enter a valid coin ID";
            return;
        }

        isLoading = true;
        errorMessage = null;
        coinHistoryData = null;

        try
        {
            var queryParams = new Dictionary<string, string?>
            {
                { "interval", interval },
                { "length", dataLength.ToString() },
                { "vs_currency", vsCurrency }
            };
            var url = QueryHelpers.AddQueryString($"history/coins/{targetCoinId}", queryParams);
            var response = await Http.GetFromJsonAsync<ApiResponse>(url);

            if (response?.status?.code != 0)
                errorMessage = $"{response?.status?.timestamp} - Error {response?.status?.code}: {response?.status?.message}";

            if (response?.data != null)
            {
                coinHistoryData = response.data;
            }
            else
                errorMessage = "No data found.";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
            Console.WriteLine($"API Request Error: {ex}");
            
            if (ex.Message.Contains("JSON") || ex.Message.Contains("convert"))
            {
                errorMessage += " (Data format issue - check the console for more details)";
            }
        }
        finally
        {
            isLoading = false;
        }
    }

    public class ApiResponse
    {
        public CoinHistoryDataResponse? data { get; set; }
        public Status? status { get; set; }
    }

    public class CoinHistoryDataResponse
    {
        public string? id { get; set; }
        public string? logo { get; set; }
        public MarketChart[]? market_chart { get; set; }
        public string? name { get; set; }
        public string? symbol { get; set; }
        public string? vs_currency { get; set; }

        public PageInfo? page_info { get; set; }
    }

    public class MarketChart
    {
        public double market_cap { get; set; }
        public double price { get; set; }
        public long timestamp { get; set; }
        public double vol_spot_24h { get; set; }
    }

    public class PageInfo
    {
        public int total_results { get; set; }
    }

    public class Status
    {
        public int code { get; set; }
        public string? message { get; set; }
        public long timestamp { get; set; }
    }
}